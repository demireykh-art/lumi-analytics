<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>루미의원 CRM - 카테고리 기반 관리 시스템</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">💎</div>
            <div class="logo-text">
                <h1>LUMI CRM</h1>
                <span>카테고리 기반 시술 관리</span>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="App.syncNaver()">
                <span>🔄</span> 네이버 동기화
            </button>
            <div class="status-badge">
                <span class="status-dot"></span> <span id="connectionStatus">연동 대기</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-tabs">
        <div class="nav-tab active" data-tab="dashboard">📊 대시보드</div>
        <div class="nav-tab" data-tab="categories">📁 카테고리 관리</div>
        <div class="nav-tab" data-tab="treatments">💉 시술 설정</div>
        <div class="nav-tab" data-tab="combination">🎯 콤비네이션</div>
        <div class="nav-tab" data-tab="reservation">📅 예약 관리</div>
        <div class="nav-tab" data-tab="staff">👥 인력 설정</div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- 대시보드 탭 -->
        <section id="dashboard" class="tab-panel active">
            <div class="section-header">
                <h2>📊 카테고리별 매출 현황</h2>
                <p>2024년 11~12월 데이터 기준</p>
            </div>
            
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <h3>카테고리별 매출 순위</h3>
                    </div>
                    <div id="categoryRevenueChart" class="chart-container"></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>객단가 분석</h3>
                        <span class="badge">카테고리별 평균</span>
                    </div>
                    <div id="priceAnalysisChart" class="chart-container"></div>
                </div>
            </div>
            
            <div class="section-header" style="margin-top: 32px;">
                <h3>✨ 추천 콤비네이션</h3>
            </div>
            <div id="recommendedCombos" class="combo-grid"></div>
        </section>

        <!-- 카테고리 관리 탭 -->
        <section id="categories" class="tab-panel">
            <div class="section-header">
                <h2>📁 카테고리 관리</h2>
                <p>각 카테고리의 기본 인력시간코드와 소요시간을 설정합니다. 시술에 개별 설정이 없으면 카테고리 기본값이 적용됩니다.</p>
            </div>
            
            <div class="code-legend">
                <h4>📋 인력시간코드 규칙</h4>
                <div class="legend-grid">
                    <div class="legend-item"><span class="code">H</span><span>대표원장</span></div>
                    <div class="legend-item"><span class="code">S</span><span>부원장</span></div>
                    <div class="legend-item"><span class="code">N</span><span>간호사</span></div>
                    <div class="legend-item"><span class="code">A</span><span>관리사</span></div>
                    <div class="legend-item"><span class="code">HS</span><span>원장 중 택1</span></div>
                    <div class="legend-item example"><span class="code">H10N5A20</span><span>= 원장10분 + 간호사5분 + 관리사20분</span></div>
                </div>
            </div>
            
            <div id="categoryGrid" class="category-grid"></div>
            
            <button class="btn btn-outline" onclick="App.addCategory()" style="margin-top: 20px;">
                + 카테고리 추가
            </button>
        </section>

        <!-- 시술 설정 탭 -->
        <section id="treatments" class="tab-panel">
            <div class="section-header">
                <h2>💉 시술 설정</h2>
                <p>개별 시술의 인력시간코드를 설정합니다. 빈칸이면 카테고리 기본값이 적용됩니다.</p>
            </div>
            
            <div class="table-actions">
                <button class="btn btn-primary" onclick="App.openAddTreatmentModal()">
                    + 시술 추가
                </button>
                <input type="text" class="search-input" placeholder="🔍 시술명 검색..." 
                       oninput="App.filterTreatments(this.value)">
            </div>
            
            <div class="table-container">
                <table class="treatment-table">
                    <thead>
                        <tr>
                            <th>시술명</th>
                            <th>가격</th>
                            <th>건수</th>
                            <th>인력시간코드 (개별)</th>
                            <th>소요시간 (개별)</th>
                            <th>적용값</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody id="treatmentTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- 콤비네이션 탭 -->
        <section id="combination" class="tab-panel">
            <div class="section-header">
                <h2>🎯 시술 콤비네이션 설계</h2>
                <p>저객단가 시술과 고객단가 시술을 묶어 패키지를 구성합니다</p>
            </div>
            
            <div class="combo-builder">
                <div class="combo-column">
                    <h3>📋 저객단가 카테고리</h3>
                    <p class="subtitle">고객 유입용 (평균 30만원 미만)</p>
                    <div id="lowPriceCategories" class="category-list"></div>
                </div>
                
                <div class="combo-arrow">➕</div>
                
                <div class="combo-column">
                    <h3>💎 고객단가 카테고리</h3>
                    <p class="subtitle">수익 극대화 (평균 50만원 이상)</p>
                    <div id="highPriceCategories" class="category-list"></div>
                </div>
                
                <div class="combo-arrow">＝</div>
                
                <div class="combo-column result">
                    <h3>🎁 패키지 구성</h3>
                    <div id="packageBuilder" class="package-builder">
                        <div class="empty-state">카테고리를 선택하세요</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 예약 관리 탭 -->
        <section id="reservation" class="tab-panel">
            <div class="section-header">
                <h2>📅 예약 슬롯 관리</h2>
                <p>인력시간코드 기반 예약 가용성 확인</p>
            </div>
            
            <div class="date-selector">
                <button class="date-nav" onclick="App.prevDay()">◀</button>
                <div class="current-date" id="currentDate"></div>
                <button class="date-nav" onclick="App.nextDay()">▶</button>
                <button class="btn btn-primary" onclick="App.goToday()">오늘</button>
            </div>
            
            <div class="staff-status">
                <h3>👥 금일 인력 현황</h3>
                <div id="staffGrid" class="staff-grid"></div>
            </div>
            
            <div class="timeline-container">
                <div class="timeline-header">
                    <div class="time-col">시간</div>
                    <div class="staff-cols" id="timelineHeader"></div>
                </div>
                <div class="timeline-body" id="timelineBody"></div>
            </div>
            
            <button class="fab" onclick="App.openReservationModal()">+</button>
        </section>

        <!-- 인력 설정 탭 -->
        <section id="staff" class="tab-panel">
            <div class="section-header">
                <h2>👥 인력 현황 설정</h2>
                <p>직원 정보와 역할을 관리합니다</p>
            </div>
            
            <div class="capacity-summary">
                <h4>현재 인력 구성</h4>
                <div class="capacity-grid">
                    <div class="capacity-item">
                        <span class="role-badge H">H</span>
                        <span>대표원장 <strong id="capacityH">1</strong>명</span>
                    </div>
                    <div class="capacity-item">
                        <span class="role-badge S">S</span>
                        <span>부원장 <strong id="capacityS">2</strong>명</span>
                    </div>
                    <div class="capacity-item">
                        <span class="role-badge N">N</span>
                        <span>간호사 <strong id="capacityN">1</strong>명</span>
                    </div>
                    <div class="capacity-item">
                        <span class="role-badge A">A</span>
                        <span>관리사 <strong id="capacityA">2</strong>명</span>
                    </div>
                </div>
            </div>
            
            <div id="staffConfigGrid" class="staff-config-grid"></div>
            
            <button class="btn btn-outline" onclick="App.addStaff()">
                + 인력 추가
            </button>
        </section>
    </main>

    <!-- 시술 추가 모달 -->
    <div class="modal" id="treatmentModal">
        <div class="modal-backdrop" onclick="App.closeModal('treatmentModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>💉 시술 추가/수정</h3>
                <button class="modal-close" onclick="App.closeModal('treatmentModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>시술명 *</label>
                    <input type="text" id="treatmentName" placeholder="시술명 입력">
                </div>
                <div class="form-group">
                    <label>카테고리 *</label>
                    <select id="treatmentCategory"></select>
                </div>
                <div class="form-group">
                    <label>가격 (원)</label>
                    <input type="number" id="treatmentPrice" placeholder="330000">
                </div>
                <div class="form-group">
                    <label>인력시간코드 (선택 - 비워두면 카테고리 기본값)</label>
                    <input type="text" id="treatmentCode" placeholder="예: H10N5A20">
                </div>
                <div class="form-group">
                    <label>소요시간 (선택)</label>
                    <input type="number" id="treatmentTime" placeholder="분 단위" min="5" step="5">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="App.closeModal('treatmentModal')">취소</button>
                <button class="btn btn-primary" onclick="App.saveTreatment()">저장</button>
            </div>
        </div>
    </div>

    <!-- 예약 모달 -->
    <div class="modal" id="reservationModal">
        <div class="modal-backdrop" onclick="App.closeModal('reservationModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>📅 새 예약 등록</h3>
                <button class="modal-close" onclick="App.closeModal('reservationModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>고객명</label>
                    <input type="text" id="customerName" placeholder="고객명">
                </div>
                <div class="form-group">
                    <label>연락처</label>
                    <input type="tel" id="customerPhone" placeholder="010-0000-0000">
                </div>
                <div class="form-group">
                    <label>시술 선택</label>
                    <select id="reservationTreatment" onchange="App.onTreatmentSelect()"></select>
                </div>
                <div class="form-group">
                    <label>예약 시간</label>
                    <select id="reservationTime" onchange="App.checkSlotAvailability()"></select>
                </div>
                <div class="code-display">
                    <span class="label">인력시간코드:</span>
                    <span id="selectedTreatmentCode">-</span>
                    <span class="label" style="margin-left: 16px;">소요시간:</span>
                    <span id="selectedTreatmentTime">-</span>
                </div>
                <div id="slotAvailability" class="slot-availability"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="App.closeModal('reservationModal')">취소</button>
                <button class="btn btn-primary" onclick="App.saveReservation()">예약 등록</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/reservation.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
